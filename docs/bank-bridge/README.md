# Сервис Bank Bridge

Bank Bridge отвечает за обмен данными с внешними банковскими API и нормализацию полученных операций. Он работает отдельно от основного приложения, взаимодействуя с Kafka и системой мониторинга.

## Потоки данных

1. Клиентское приложение инициирует импорт данных и помещает сообщение в топик `bank.raw`.
2. Сервис читает эти сообщения, обращается к API банка и публикует результат в `bank.norm` либо `bank.err`.
3. Нормализованные данные далее обрабатываются ядром системы.

Пример схемы потоков данных приведён в файле `dataflow.puml`.

## Схемы сообщений

В каталоге `schemas/bank-bridge` описаны JSON‑схемы для трёх типов сообщений:

- **bank.raw** – исходные параметры запроса к банку.
- **bank.norm** – нормализованная операция после успешной обработки.
- **bank.err** – информация об ошибке с исходным сообщением.

Каждая схема версионируется и проверяется в тестах `tests/bank_bridge/test_contracts.py`.
Схемы располагаются в каталогах `<topic>/<version>`. При изменении
спецификации создаётся новый каталог версии, а изменения вносятся через
pull request. На старте сервиса все схемы автоматически регистрируются в
Apicurio Schema Registry, что позволяет воспроизвести состояние схем в
любом окружении.

## Лимиты

Для контейнера сервиса в `docker-compose.yml` задано ограничение ресурсов: не более 1 CPU и 512 MB памяти.
При обращении к внешним API учитываются ответы 429, их количество фиксируется отдельной метрикой.

## Метрики

Сервис экспортирует метрики Prometheus на эндпойнте `/metrics`:

- `bankbridge_fetch_latency_ms` – гистограмма времени вызова внешних API.
- `bankbridge_txn_count` – число обработанных банковских операций.
- `bankbridge_error_total` – количество ошибок при запросах к банкам.
- `bankbridge_rate_limited` – счётчик ответов с кодом 429.

## Логи

Сервис пишет структурированные логи в stdout в формате JSON. Пример
минимальной конфигурации Promtail для передачи логов в Loki:

```yaml
serverPort: 9080

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  - job_name: bank-bridge
    static_configs:
      - targets: [localhost]
        labels:
          job: bank-bridge
          __path__: /var/log/containers/*bank-bridge*.log
```
Полный пример доступен в файле `promtail-example.yml`.

## Тестовый контур

Для локального тестирования используется `tests/bank_bridge/docker-compose.yml`. Он поднимает только Kafka. Запуск:

```bash
docker compose -f tests/bank_bridge/docker-compose.yml up -d
```

После старта доступен порт 9092 для подключения тестов.

## Локальное развёртывание

1. Скопируйте `env/.env.example` в `.env` и заполните переменные для доступа к банкам.
2. Соберите Docker‑образ и запустите контейнер:

```bash
docker build -t bank-bridge -f services/bank_bridge/Dockerfile .
docker run --env-file .env -p 8080:8080 bank-bridge
```

Сервис будет доступен на `http://localhost:8080`. Для разработки можно запустить его напрямую:

```bash
uvicorn services.bank_bridge.app:app --reload --port 8080
```
